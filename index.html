<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Topuz Ailesi Görev Macerası</title>
    
    <!-- Stil ve Font Dosyaları -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style> body { font-family: 'Inter', sans-serif; } </style>
    
    <!-- Gerekli Kütüphaneler (Doğru Sırada) -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lucide-react@0.292.0/dist/umd/lucide-react.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
</head>
<body class="bg-slate-100">
    <div id="root"></div>

    <script type="text/babel">
        // --- Kütüphaneleri Global Kapsamdan Alma ---
        const { useState, useEffect, useMemo } = React;
        const { render } = ReactDOM;
        const { CheckCircle, Star, Award, BookOpen, Smile, BrainCircuit, Plus, Trash2, Users, Settings, AlertTriangle, ShieldCheck } = lucide;

        // --- Firebase Konfigürasyonu ---
        const firebaseConfig = {
            apiKey: "AIzaSyCq0cVlW_edwAROUXfKceC2rJzFps_wRFM",
            authDomain: "gorev-39d45.firebaseapp.com",
            projectId: "gorev-39d45",
            storageBucket: "gorev-39d45.firebasestorage.app",
            messagingSenderId: "340635577706",
            appId: "1:340635577706:web:17b8864987b6d070990913",
            measurementId: "G-WS9NKLTKV1"
        };
        
        // --- Firebase Servislerini Başlatma ---
        let app, auth, db;
        try {
            if (window.firebase && firebaseConfig.apiKey) {
                app = firebase.initializeApp(firebaseConfig);
                auth = firebase.auth();
                db = firebase.firestore();
            }
        } catch (e) {
            console.error("Firebase başlatma hatası:", e);
        }

        // --- Yardımcı Fonksiyonlar ---
        const getTodayDateString = () => new Date(new Date().getTime() - (new Date().getTimezoneOffset()*60*1000)).toISOString().split('T')[0];
        const getFormattedDateTR = () => new Date().toLocaleDateString('tr-TR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

        // --- Ana Uygulama Komponenti ---
        function App() {
            const [appData, setAppData] = useState(null);
            const [currentUser, setCurrentUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);

            useEffect(() => {
                if (!app) {
                    setError("Firebase yapılandırması eksik veya hatalı.");
                    setLoading(false);
                }
            }, []);

            const dataDocRef = useMemo(() => {
                if (!db) return null;
                return db.collection('gorev-macerasi-data').doc('main');
            }, []);

            useEffect(() => {
                if (!auth || !dataDocRef) {
                    if(!error) setLoading(false);
                    return;
                }

                const unsubscribeAuth = auth.onAuthStateChanged(user => {
                    if (user) {
                        const unsubscribeSnapshot = dataDocRef.onSnapshot(docSnap => {
                            if (docSnap.exists) {
                                setAppData(docSnap.data());
                            } else {
                                const initialData = {
                                    users: [],
                                    tasks: [
                                        { id: 'task1', text: 'Kitap oku', icon: 'BookOpen', points: 1 },
                                        { id: 'task2', text: 'Diş fırçala', icon: 'Smile', points: 1 }
                                    ],
                                    completions: {},
                                    weeklyReward: 'Hafta sonu sinema keyfi!',
                                };
                                dataDocRef.set(initialData).then(() => setAppData(initialData));
                            }
                            setLoading(false);
                        }, firestoreError => {
                            setError("Veri alınırken hata oluştu: " + firestoreError.message);
                            setLoading(false);
                        });
                        return () => unsubscribeSnapshot();
                    } else {
                        auth.signInAnonymously().catch(authError => {
                             setError("Oturum açılamadı. Firebase ayarlarınızı ve kurallarınızı kontrol edin.");
                             setLoading(false);
                        });
                    }
                });
                return () => unsubscribeAuth();
            }, [dataDocRef, error]);

            const updateFirestore = async (newData) => {
                if (!dataDocRef) return;
                try {
                    await dataDocRef.set({ ...(appData || {}), ...newData }, { merge: true });
                } catch (updateError) {
                    setError("Veri kaydedilemedi.");
                }
            };
            
            const addUser = (name) => {
                const newUser = { id: `user_${Date.now()}`, name, points: 0 };
                const updatedUsers = [...(appData?.users || []), newUser];
                updateFirestore({ users: updatedUsers });
            };

            const addTask = (text, points) => {
                const newTask = { id: `task_${Date.now()}`, text, icon: 'CheckCircle', points };
                const updatedTasks = [...(appData?.tasks || []), newTask];
                updateFirestore({ tasks: updatedTasks });
            };

            const deleteTask = (taskId) => {
                const updatedTasks = (appData?.tasks || []).filter(t => t.id !== taskId);
                updateFirestore({ tasks: updatedTasks });
            };

            const toggleTaskCompletion = (task) => {
                if (currentUser.isAdmin) return;
                const today = getTodayDateString();
                const completions = JSON.parse(JSON.stringify(appData.completions || {}));
                
                if (!completions[today]) completions[today] = {};
                if (!completions[today][currentUser.id]) completions[today][currentUser.id] = [];

                const userCompletionsToday = completions[today][currentUser.id];
                const taskIndex = userCompletionsToday.indexOf(task.id);
                const pointsChange = task.points || 1;
                
                if (taskIndex > -1) {
                    userCompletionsToday.splice(taskIndex, 1);
                } else {
                    userCompletionsToday.push(task.id);
                }
                
                const updatedUsers = appData.users.map(u => {
                    if (u.id === currentUser.id) {
                        const currentPoints = u.points || 0;
                        const newPoints = taskIndex > -1 ? currentPoints - pointsChange : currentPoints + pointsChange;
                        return { ...u, points: Math.max(0, newPoints) };
                    }
                    return u;
                });

                updateFirestore({ completions, users: updatedUsers });
            };
            
            const updateWeeklyReward = (newReward) => {
                updateFirestore({ weeklyReward: newReward });
            };

            if (loading) return <div className="flex items-center justify-center h-screen bg-blue-50 text-blue-700 font-semibold">Yükleniyor...</div>;
            if (error) return <ErrorScreen message={error} />;
            if (!appData) return <div className="flex items-center justify-center h-screen bg-blue-50">Veriler hazırlanıyor...</div>;
            if (!currentUser) return <UserSelectionScreen users={appData.users || []} onSelectUser={setCurrentUser} onAddUser={addUser} />;
            
            return (
                <Dashboard 
                    user={currentUser}
                    appData={appData}
                    onToggleTask={toggleTaskCompletion}
                    onAddTask={addTask}
                    onDeleteTask={deleteTask}
                    onUpdateReward={updateWeeklyReward}
                    onSwitchUser={() => setCurrentUser(null)}
                />
            );
        }

        // --- Komponentler ---
        function UserSelectionScreen({ users, onSelectUser, onAddUser }) {
            const [newUserName, setNewUserName] = useState('');
            const [showAdminLogin, setShowAdminLogin] = useState(false);
            const handleAddUser = e => { e.preventDefault(); if (newUserName.trim()) { onAddUser(newUserName.trim()); setNewUserName(''); }};
            if (showAdminLogin) return <AdminLoginModal onLogin={onSelectUser} onCancel={() => setShowAdminLogin(false)} />;
            return (
                <div className="min-h-screen bg-gradient-to-br from-blue-200 to-cyan-200 flex flex-col items-center justify-center p-4">
                    <div className="w-full max-w-md bg-white/80 backdrop-blur-sm rounded-2xl shadow-xl p-8 text-center">
                        <Users className="mx-auto h-16 w-16 text-blue-500 mb-4" />
                        <h1 className="text-3xl font-bold text-slate-800 mb-2">Topuz Ailesi Görev Macerası</h1>
                        <p className="text-slate-600 mb-8">Kim Oynuyor?</p>
                        <div className="space-y-3 mb-6">
                            {(users || []).map(user => (
                                <button key={user.id} onClick={() => onSelectUser(user)} className="w-full text-left p-4 bg-white rounded-lg shadow-md hover:bg-blue-100 hover:shadow-lg transition-all flex items-center justify-between">
                                    <div className="flex items-center">
                                        <span className="flex-shrink-0 h-10 w-10 rounded-full bg-blue-500 text-white font-bold flex items-center justify-center text-lg mr-4">{user.name.charAt(0)}</span>
                                        <span className="text-xl font-semibold text-slate-700">{user.name}</span>
                                    </div>
                                    <div className="flex items-center gap-1 text-yellow-600 font-semibold pr-2"><Star className="w-5 h-5 text-yellow-500" /><span>{user.points || 0}</span></div>
                                </button>
                            ))}
                        </div>
                        <form onSubmit={handleAddUser} className="flex gap-2 mb-4">
                            <input type="text" value={newUserName} onChange={e => setNewUserName(e.target.value)} placeholder="Yeni Maceracı Ekle" className="flex-grow p-3 border-2 border-slate-300 rounded-lg" />
                            <button type="submit" className="p-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700"><Plus /></button>
                        </form>
                        <button onClick={() => setShowAdminLogin(true)} className="text-sm text-slate-500 hover:text-blue-600">Yönetici Girişi</button>
                    </div>
                </div>
            );
        };

        function AdminLoginModal({ onLogin, onCancel }) {
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const handleSubmit = e => { e.preventDefault(); if (password.toUpperCase() === "ADMIN") onLogin({ id: 'admin', name: 'Yönetici', isAdmin: true, points: '∞' }); else { setError('Hatalı şifre!'); setPassword(''); }};
            return (
                <div className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50">
                    <div className="bg-white rounded-2xl shadow-2xl p-8 text-center w-full max-w-sm">
                        <ShieldCheck className="mx-auto h-16 w-16 text-blue-500 mb-4" />
                        <h2 className="text-2xl font-bold text-slate-800 mb-4">Yönetici Girişi</h2>
                        <form onSubmit={handleSubmit}>
                            <input type="password" value={password} onChange={e => setPassword(e.target.value)} placeholder="Yönetici Şifresi" className="w-full p-3 border-2 border-slate-300 rounded-lg" />
                            {error && <p className="text-red-500 text-sm mt-2">{error}</p>}
                            <div className="flex gap-3 mt-6">
                                <button type="button" onClick={onCancel} className="flex-1 p-3 bg-slate-200 text-slate-700 rounded-lg">İptal</button>
                                <button type="submit" className="flex-1 p-3 bg-blue-600 text-white rounded-lg">Giriş Yap</button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };

        function Dashboard({ user, appData, onToggleTask, onAddTask, onDeleteTask, onUpdateReward, onSwitchUser }) {
            const displayedUser = useMemo(() => appData?.users?.find(u => u.id === user.id) || user, [appData?.users, user.id]);
            const isUserAdmin = user.isAdmin || false;
            const [manageMode, setManageMode] = useState(isUserAdmin);

            return (
                <div className="bg-slate-50 min-h-screen font-sans">
                    <div className="container mx-auto p-4 max-w-4xl">
                        <header className="flex justify-between items-center mb-6">
                            <div><h1 className="text-4xl font-bold text-slate-800 flex items-center gap-2">{displayedUser.name}{isUserAdmin && <ShieldCheck className="w-8 h-8 text-blue-500" />}</h1></div>
                            <div className="flex items-center gap-4">
                                <div className="flex items-center gap-2 bg-yellow-100 text-yellow-800 font-bold py-2 px-4 rounded-full"><Star className="w-6 h-6 text-yellow-500" /><span>{displayedUser?.points || 0}</span></div>
                                {isUserAdmin && <button onClick={() => setManageMode(!manageMode)} className={`p-3 rounded-full transition ${manageMode ? 'bg-blue-500 text-white' : 'bg-slate-200 text-slate-600'}`}><Settings /></button>}
                                <button onClick={onSwitchUser} className="p-3 bg-slate-200 text-slate-600 rounded-full hover:bg-slate-300"><Users /></button>
                            </div>
                        </header>
                         <div className="grid grid-cols-1 md:grid-cols-3 ga
