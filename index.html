<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Topuz Ailesi Görev Macerası</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- DEĞİŞİKLİK: Tarayıcı sekmesi için tik ikonu eklendi -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>✔️</text></svg>">
    <style> 
        body { font-family: 'Inter', sans-serif; } 
        .task-checkbox { width: 1.5rem; height: 1.5rem; cursor: pointer; }
        .icon { width: 1.5rem; height: 1.5rem; }
        .icon-lg { width: 3rem; height: 3rem; }
        .icon-sm { width: 1rem; height: 1rem; }
        #management-panel {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out;
        }
        #management-panel.open {
            max-height: 1000px;
        }
        .chevron-icon { transition: transform 0.3s ease; }
        .chevron-icon.open { transform: rotate(180deg); }
    </style>
</head>
<body class="bg-slate-100">

    <div id="app" class="container mx-auto p-4 max-w-4xl"></div>

    <script>
        // --- İKONLAR ---
        const ICONS = {
            home: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-width="2" class="icon-lg mx-auto text-blue-600 mb-2" viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>`,
            plus: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-width="2" class="icon mr-2" viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>`,
            trash: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-width="2" class="icon-sm" viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>`,
            award: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-width="2" class="icon" viewBox="0 0 24 24"><circle cx="12" cy="8" r="7"/><polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"/></svg>`,
            chevronDown: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-width="2" class="icon" viewBox="0 0 24 24"><polyline points="6 9 12 15 18 9"/></svg>`,
            refresh: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-width="2" class="icon mr-2" viewBox="0 0 24 24"><polyline points="23 4 23 10 17 10"/><path d="M1 20a11 11 0 0 0 17.63-3"/><polyline points="1 14 1 20 7 20"/></svg>`
        };

        // --- STATE ---
        const defaultState = {
            users: [
                { id: 'user1', name: 'Selo' },
                { id: 'user2', name: 'Ömer' }
            ],
            tasks: [
                { id: 'task1', text: 'Kitap 50 Sf', points: 5 },
                { id: 'task2', text: 'Diş Fırçala', points: 2 },
                { id: 'task3', text: 'Yatak Topla', points: 2 },
                { id: 'task4', text: 'Ezber Tekrarı', points: 5 },
                { id: 'task5', text: 'Kuran', points: 10 }
            ],
            completions: {},
            weeklyReward: 'Sinema',
            specialRewards: [
                { id: 'reward1', text: '30 Dakika Bilgisayar Hakkı', cost: 50 }
            ],
            isManagementOpen: false,
        };

        let state = {};
        let currentDate = new Date();

        // --- LOCALSTORAGE ---
        function saveData() {
            localStorage.setItem('gorevTablosuData_vanilla_v12', JSON.stringify(state));
        }
        function loadData() {
            const saved = localStorage.getItem('gorevTablosuData_vanilla_v12');
            if (saved) {
                state = { ...defaultState, ...JSON.parse(saved) };
            } else {
                state = JSON.parse(JSON.stringify(defaultState));
            }
        }

        // --- YARDIMCI FONKSİYONLAR ---
        const toISODateString = d => d.toISOString().split('T')[0];
        const getFormattedDateTR = d => d.toLocaleDateString('tr-TR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

        function calculateUserPoints() {
            const points = {};
            state.users.forEach(u => points[u.id] = 0);
            Object.values(state.completions).forEach(dc => {
                Object.entries(dc).forEach(([taskId, completedUserIds]) => {
                    const task = state.tasks.find(t => t.id === taskId);
                    if (task) {
                        completedUserIds.forEach(uid => {
                            if (points[uid] !== undefined) points[uid] += task.points;
                        });
                    }
                });
            });
            return points;
        }

        function getMonday(d) {
            const date = new Date(d);
            const day = date.getDay(), diff = date.getDate() - day + (day === 0 ? -6 : 1);
            date.setDate(diff);
            date.setHours(0,0,0,0);
            return date;
        }

        // --- DOM RENDER ---
        function renderApp() {
            const userPoints = calculateUserPoints();
            const currentDateKey = toISODateString(currentDate);
            const isToday = currentDateKey === toISODateString(new Date());

            const usersBar = state.users.map(user => `
                <div class="text-center bg-yellow-100 text-yellow-800 rounded-lg p-3 shadow-sm flex-1 mx-1">
                    <div class="font-bold text-xl">${user.name}</div>
                    <div class="text-2xl font-extrabold">${userPoints[user.id] || 0} puan</div>
                </div>
            `).join('');

            let tableRowsHtml = '';
            state.tasks.filter(t => !t.id.startsWith('claim_')).forEach(task => {
                const completedBy = state.completions[currentDateKey]?.[task.id] || [];
                let userCheckboxes = '';
                state.users.forEach(user => {
                    const isChecked = completedBy.includes(user.id);
                    userCheckboxes += `<td class="p-4 text-center"><input type="checkbox" class="task-checkbox accent-green-500" data-task-id="${task.id}" data-user-id="${user.id}" ${isChecked ? "checked" : ""}></td>`;
                });
                tableRowsHtml += `<tr class="border-b">
                    <td class="p-4 font-medium">${task.text}</td>
                    <td class="p-4 text-center font-bold text-blue-600">${task.points}</td>
                    ${userCheckboxes}
                </tr>`;
            });

            let weeklyProgressHtml = '';
            state.users.forEach(user => {
                const today = new Date();
                const monday = getMonday(today);
                let completedDays = 0;
                const realTasks = state.tasks.filter(t => !t.id.startsWith('claim_'));
                for (let i = 0; i < 7; i++) {
                    const dayToCheck = new Date(monday); dayToCheck.setDate(monday.getDate() + i);
                    if (dayToCheck > today) break;
                    const dateString = toISODateString(dayToCheck);
                    let allTasksDone = true;
                    if(realTasks.length === 0) allTasksDone = false;
                    for (const task of realTasks) {
                        const completedBy = state.completions[dateString]?.[task.id] || [];
                        if (!completedBy.includes(user.id)) {
                            allTasksDone = false;
                            break;
                        }
                    }
                    if (allTasksDone) completedDays++;
                }
                const progressPercentage = (completedDays / 7) * 100;
                weeklyProgressHtml += `
                    <div>
                        <div class="flex justify-between mb-1"><span class="text-base font-medium text-blue-700">${user.name}</span>
                        <span class="text-sm font-medium text-blue-700">${completedDays}/7</span></div>
                        <div class="w-full bg-blue-200 rounded-full h-3 mb-2">
                          <div class="bg-blue-600 h-3 rounded-full" style="width:${progressPercentage}%"></div>
                        </div>
                    </div>
                `;
            });

            const rewardsHtml = state.users.map(user => {
                const reward = state.specialRewards[0];
                const canClaim = (userPoints[user.id] || 0) >= reward.cost;
                return `<div class="flex items-center justify-between bg-white p-3 rounded-lg shadow-sm">
                    <span class="font-semibold">${user.name}: ${reward.text} <span class="font-bold">(${reward.cost} puan)</span></span>
                    <button class="special-reward-btn px-3 py-1 rounded ${canClaim ? "bg-indigo-500 text-white" : "bg-gray-300 text-gray-500 cursor-not-allowed"}"
                        data-user-id="${user.id}" data-reward-id="${reward.id}" ${canClaim ? '' : 'disabled'}>
                        Kullan
                    </button>
                </div>`;
            }).join('');

            const taskListManage = state.tasks.filter(t => !t.id.startsWith('claim_')).map(task => `
                <div class="flex items-center gap-2">
                    <span class="flex-1">${task.text}</span>
                    <input type="number" class="edit-task-points w-16 p-1 border rounded" min="1" max="99" value="${task.points}" data-task-id="${task.id}">
                    <button class="delete-task-btn text-red-600" data-task-id="${task.id}">${ICONS.trash}</button>
                </div>
            `).join('');

            document.getElementById('app').innerHTML = `
                <div class="w-full">
                    <header class="text-center mb-6">${ICONS.home}<h1 class="text-3xl font-bold text-slate-800">Topuz Günlük Görev</h1></header>
                    <div class="bg-white rounded-2xl shadow-xl p-6">
                        <div class="flex justify-center flex-wrap gap-2 mb-6">${usersBar}</div>
                        <div class="flex items-center justify-center my-6">
                            <button id="prev-day-btn" class="p-2 rounded-full hover:bg-slate-200">&#8592;</button>
                            <h2 class="text-xl font-semibold mx-2">${getFormattedDateTR(currentDate)}</h2>
                            <button id="next-day-btn" class="p-2 rounded-full hover:bg-slate-200 ${isToday ? 'opacity-30 cursor-not-allowed' : ''}" ${isToday ? 'disabled' : ''}>&#8594;</button>
                        </div>
                        <div class="overflow-x-auto"><table class="w-full text-left border-collapse"><thead>
                            <tr class="bg-slate-200"><th class="p-4">Görev</th><th class="p-4">Puan</th>${state.users.map(u=>`<th class="p-4">${u.name}</th>`).join('')}</tr>
                        </thead><tbody>${tableRowsHtml}</tbody></table></div>
                        <div class="mt-8 pt-6 border-t grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <div class="rounded-2xl shadow-lg p-6 bg-amber-50">
                                <h3 class="text-xl font-bold text-amber-800 mb-4 flex items-center gap-2">${ICONS.award} Haftalık İlerleme</h3>
                                <p class="text-amber-700 mb-4">Haftalık Ödül: <span class="font-bold">${state.weeklyReward}</span></p>
                                <div class="space-y-4">${weeklyProgressHtml}</div>
                            </div>
                            <div class="rounded-2xl shadow-lg p-6 bg-indigo-50">
                                <h3 class="text-xl font-bold text-indigo-800 mb-4">Özel Ödüller</h3>
                                <div class="space-y-4">${rewardsHtml}</div>
                            </div>
                        </div>
                        <div class="mt-8 pt-6 border-t">
                            <button id="toggle-management-btn" class="w-full flex justify-between items-center p-2 rounded-lg hover:bg-slate-100">
                                <h3 class="text-xl font-bold">Görevleri Yönet</h3>
                                <span class="chevron-icon ${state.isManagementOpen ? 'open' : ''}">${ICONS.chevronDown}</span>
                            </button>
                            <div id="management-panel" class="${state.isManagementOpen ? 'open' : ''} mt-4">
                                <form id="add-task-form" class="grid grid-cols-1 md:grid-cols-4 gap-3 mb-6 items-center">
                                    <input id="new-task-text" type="text" placeholder="Yeni görev adı..." class="col-span-2 p-2 border rounded" required>
                                    <input id="new-task-points" type="number" placeholder="Puan" class="p-2 border rounded" min="1" max="99" value="1" required>
                                    <button type="submit" class="bg-green-600 text-white rounded p-2 flex items-center justify-center gap-1">${ICONS.plus} Ekle</button>
                                </form>
                                <div id="task-list-management" class="space-y-2">
                                    <h4 class="text-md font-semibold text-slate-500">Mevcut Görevler</h4>
                                    ${taskListManage}
                                </div>
                                <div class="mt-6 pt-4 border-t border-red-300">
                                    <button id="reset-all-btn" class="w-full p-3 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 flex items-center justify-center">${ICONS.refresh} Tümünü Sıfırla</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            saveData();
        }

        // --- EVENTLER ---
        function attachEventListeners() {
            const app = document.getElementById('app');
            app.addEventListener('change', (e) => {
                if (e.target.classList.contains('task-checkbox')) {
                    const taskId = e.target.dataset.taskId;
                    const userId = e.target.dataset.userId;
                    toggleCompletion(taskId, userId);
                }
                if (e.target.classList.contains('edit-task-points')) {
                    const taskId = e.target.dataset.taskId;
                    updateTaskPoints(taskId, e.target.value);
                }
            });

            app.addEventListener('click', (e) => {
                const target = e.target.closest('button');
                if(!target) return;

                if (target.closest('.delete-task-btn')) {
                    const taskId = target.closest('.delete-task-btn').dataset.taskId;
                    if (confirm('Görev silinsin mi?')) deleteTask(taskId);
                }
                if (target.id === 'prev-day-btn') changeDate(-1);
                if (target.id === 'next-day-btn') changeDate(1);
                if (target.closest('.special-reward-btn')) {
                    const btn = target.closest('.special-reward-btn');
                    const userId = btn.dataset.userId, rewardId = btn.dataset.rewardId;
                    const reward = state.specialRewards.find(r => r.id === rewardId);
                    if (reward && confirm(`${reward.cost} puan ile "${reward.text}" ödülünü almak istiyor musun?`)) {
                        claimSpecialReward(userId, reward);
                    }
                }
                if (target.id === 'toggle-management-btn') toggleManagementPanel();
                if (target.id === 'reset-all-btn') resetAllProgress();
            });

            app.addEventListener('submit', (e) => {
                if (e.target.id === 'add-task-form') {
                    e.preventDefault();
                    const text = document.getElementById('new-task-text').value.trim();
                    const points = document.getElementById('new-task-points').value;
                    if (text) addTask(text, points);
                }
            });
        }

        // --- STATE DEĞİŞİKLİKLERİ ---
        function addTask(text, points) {
            state.tasks.push({ id: `task_${Date.now()}`, text, points: parseInt(points) || 1 });
            saveData(); renderApp();
        }
        function deleteTask(taskId) {
            state.tasks = state.tasks.filter(t => t.id !== taskId);
            Object.keys(state.completions).forEach(date => {
                if (state.completions[date][taskId]) delete state.completions[date][taskId];
            });
            saveData(); renderApp();
        }
        function updateTaskPoints(taskId, newPoints) {
            const task = state.tasks.find(t => t.id === taskId);
            if (task) task.points = parseInt(newPoints) || 1;
            saveData(); renderApp();
        }
        function toggleCompletion(taskId, userId) {
            const dateKey = toISODateString(currentDate);
            if (!state.completions[dateKey]) state.completions[dateKey] = {};
            if (!state.completions[dateKey][taskId]) state.completions[dateKey][taskId] = [];
            const arr = state.completions[dateKey][taskId];
            const i = arr.indexOf(userId);
            if (i > -1) arr.splice(i, 1); else arr.push(userId);
            saveData(); renderApp();
        }
        function changeDate(offset) {
            currentDate.setDate(currentDate.getDate() + offset);
            renderApp();
        }
        function claimSpecialReward(userId, reward) {
            const userPoints = calculateUserPoints();
            if (userPoints[userId] >= reward.cost) {
                const rewardClaimId = `claim_${reward.id}_${Date.now()}`;
                const today = toISODateString(new Date());
                if (!state.completions[today]) state.completions[today] = {};
                state.completions[today][rewardClaimId] = [userId];
                state.tasks.push({ id: rewardClaimId, text: `Ödül Kullanımı: ${reward.text}`, points: -reward.cost });
                saveData(); renderApp();
            }
        }
        function toggleManagementPanel() {
            state.isManagementOpen = !state.isManagementOpen;
            saveData(); renderApp();
        }
        function resetAllProgress() {
            if (confirm("Tüm puanlar ve tamamlanmış görevler silinecek. Emin misin?")) {
                state.completions = {};
                state.tasks = state.tasks.filter(t => !t.id.startsWith('claim_'));
                saveData(); renderApp();
            }
        }

        // --- BAŞLAT ---
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            renderApp();
            attachEventListeners();
        });
    </script>
</body>
</html>
