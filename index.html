<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Topuz Ailesi Görev Macerası</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style> 
        body { font-family: 'Inter', sans-serif; } 
        .task-checkbox { width: 1.5rem; height: 1.5rem; cursor: pointer; }
        .icon { width: 1.5rem; height: 1.5rem; }
        .icon-lg { width: 3rem; height: 3rem; }
        .icon-sm { width: 1rem; height: 1rem; }
    </style>
</head>
<body class="bg-slate-100">

    <div id="app" class="container mx-auto p-4 max-w-4xl">
        <!-- Uygulama içeriği JavaScript ile buraya eklenecek -->
    </div>

    <script>
        // --- İKONLAR (SVG olarak) ---
        const ICONS = {
            home: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon-lg mx-auto text-blue-600 mb-2"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>`,
            plus: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon mr-2"><line x1="12" x2="12" y1="5" y2="19"/><line x1="5" x2="19" y1="12" y2="12"/></svg>`,
            trash: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon-sm"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>`,
        };

        // --- TEMEL VERİ YAPISI ---
        const state = {
            users: [
                { id: 'user1', name: 'Selo' },
                { id: 'user2', name: 'Ömer' }
            ],
            tasks: [
                { id: 'task1', text: 'Kitap Oku', points: 5 },
                { id: 'task2', text: 'Diş Fırçala', points: 2 }
            ],
            completions: {}, // { 'YYYY-MM-DD': { 'taskId': ['userId1'] } }
        };
        
        let currentDate = new Date();
        const appContainer = document.getElementById('app');

        // --- YARDIMCI FONKSİYONLAR ---
        const toISODateString = (date) => date.toISOString().split('T')[0];
        const getFormattedDateTR = (date) => date.toLocaleDateString('tr-TR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

        // --- VERİ YÖNETİMİ ---
        function saveData() {
            localStorage.setItem('gorevTablosuData_vanilla_final', JSON.stringify(state));
        }

        function loadData() {
            const savedData = localStorage.getItem('gorevTablosuData_vanilla_final');
            if (savedData) {
                const parsedData = JSON.parse(savedData);
                Object.assign(state, parsedData);
            }
        }

        // --- GÖREV FONKSİYONLARI ---
        function addTask(text, points) {
            const newTask = { id: `task_${Date.now()}`, text, points: parseInt(points, 10) || 1 };
            state.tasks.push(newTask);
            renderApp();
        }

        function deleteTask(taskId) {
            state.tasks = state.tasks.filter(t => t.id !== taskId);
            Object.keys(state.completions).forEach(date => {
                delete state.completions[date][taskId];
            });
            renderApp();
        }

        function toggleCompletion(taskId, userId) {
            const dateKey = toISODateString(currentDate);
            if (!state.completions[dateKey]) state.completions[dateKey] = {};
            if (!state.completions[dateKey][taskId]) state.completions[dateKey][taskId] = [];

            const completedBy = state.completions[dateKey][taskId];
            const userIndex = completedBy.indexOf(userId);

            if (userIndex > -1) {
                completedBy.splice(userIndex, 1);
            } else {
                completedBy.push(userId);
            }
            renderApp();
        }
        
        function changeDate(offset) {
            currentDate.setDate(currentDate.getDate() + offset);
            renderApp();
        }

        // --- RENDER FONKSİYONU: TÜM EKRANI ÇİZER ---
        function renderApp() {
            // Puanları hesapla
            const userPoints = {};
            state.users.forEach(user => { userPoints[user.id] = 0; });
            Object.values(state.completions).forEach(dailyCompletions => {
                Object.entries(dailyCompletions).forEach(([taskId, completedUserIds]) => {
                    const task = state.tasks.find(t => t.id === taskId);
                    if (task) {
                        completedUserIds.forEach(userId => {
                            if (userPoints[userId] !== undefined) {
                                userPoints[userId] += task.points;
                            }
                        });
                    }
                });
            });

            const currentDateKey = toISODateString(currentDate);
            const isToday = currentDateKey === toISODateString(new Date());

            // HTML'i oluştur
            let tableRowsHtml = '';
            state.tasks.forEach(task => {
                const completedBy = state.completions[currentDateKey]?.[task.id] || [];
                let userCheckboxesHtml = '';
                state.users.forEach(user => {
                    const isChecked = completedBy.includes(user.id);
                    userCheckboxesHtml += `
                        <td class="p-4 text-center">
                            <input type="checkbox" class="task-checkbox h-6 w-6 accent-green-500" data-task-id="${task.id}" data-user-id="${user.id}" ${isChecked ? 'checked' : ''}>
                        </td>
                    `;
                });
                tableRowsHtml += `<tr class="border-b border-slate-200"><td class="p-4 font-medium text-slate-800">${task.text}</td><td class="p-4 text-center font-bold text-blue-600">${task.points}</td>${userCheckboxesHtml}</tr>`;
            });

            appContainer.innerHTML = `
                <div class="w-full">
                    <header class="text-center mb-6">
                        ${ICONS.home}
                        <h1 class="text-4xl font-bold text-slate-800">Topuz Ailesi Görev Macerası</h1>
                    </header>
                    <div class="bg-white rounded-2xl shadow-xl p-6">
                        <div class="flex justify-center flex-wrap gap-4 sm:gap-6 mb-6">
                            ${state.users.map(user => `<div class="text-center bg-yellow-100 text-yellow-800 rounded-lg p-4 shadow-sm w-40"><p class="font-bold text-xl">${user.name}</p><p class="font-semibold text-2xl">${userPoints[user.id] || 0} Puan</p></div>`).join('')}
                        </div>
                        <div class="flex items-center justify-center my-6">
                            <button id="prev-day-btn" class="p-2 rounded-full hover:bg-slate-200"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 text-slate-600"><path d="m15 18-6-6 6-6"/></svg></button>
                            <h2 class="text-2xl font-bold text-slate-700 mx-4 text-center w-72">${getFormattedDateTR(currentDate)}</h2>
                            <button id="next-day-btn" class="p-2 rounded-full hover:bg-slate-200 ${isToday ? 'opacity-30 cursor-not-allowed' : ''}" ${isToday ? 'disabled' : ''}><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 text-slate-600"><path d="m9 18 6-6-6-6"/></svg></button>
                        </div>
                        <div class="overflow-x-auto"><table class="w-full text-left border-collapse"><thead><tr class="bg-slate-200"><th class="p-4 text-lg font-semibold text-slate-700 rounded-tl-lg">Görev</th><th class="p-4 text-lg font-semibold text-slate-700 text-center">Puan</th>${state.users.map(user => `<th class="p-4 text-lg font-semibold text-slate-700 text-center">${user.name}</th>`).join('')}</tr></thead><tbody>${tableRowsHtml.length > 0 ? tableRowsHtml : `<tr><td colspan="${state.users.length + 2}" class="text-center p-8 text-slate-500">Henüz görev eklenmemiş.</td></tr>`}</tbody></table></div>
                        <div class="mt-8 pt-6 border-t">
                            <h3 class="text-xl font-bold text-slate-700 mb-4">Görevleri Yönet</h3>
                            <form id="add-task-form" class="grid grid-cols-1 md:grid-cols-4 gap-3 mb-6 items-center">
                                <input id="new-task-text" type="text" placeholder="Yeni görev adı..." class="md:col-span-2 p-3 border-2 border-slate-200 rounded-lg" required />
                                <input id="new-task-points" type="number" min="1" value="1" placeholder="Puan" class="p-3 border-2 border-slate-200 rounded-lg" required />
                                <button type="submit" class="p-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 flex items-center justify-center">${ICONS.plus}Ekle</button>
                            </form>
                            <div id="task-list-management" class="space-y-2"><h4 class="text-md font-semibold text-slate-500">Mevcut Görevler</h4>${state.tasks.map(task => `<div class="flex justify-between items-center bg-slate-50 p-2 rounded-lg"><span class="text-slate-800">${task.text} (${task.points} Puan)</span><button class="delete-task-btn p-2 text-red-500 hover:bg-red-100 rounded-full" data-task-id="${task.id}">${ICONS.trash}</button></div>`).join('')}</div>
                        </div>
                    </div>
                </div>
            `;
            saveData();
        }

        // --- EVENT LISTENERS (OLAY DİNLEYİCİLERİ) ---
        function attachEventListeners() {
            appContainer.addEventListener('change', (e) => {
                if (e.target.classList.contains('task-checkbox')) {
                    const taskId = e.target.dataset.taskId;
                    const userId = e.target.dataset.userId;
                    toggleCompletion(taskId, userId);
                }
            });
            
            appContainer.addEventListener('click', (e) => {
                const deleteBtn = e.target.closest('.delete-task-btn');
                const prevDayBtn = e.target.closest('#prev-day-btn');
                const nextDayBtn = e.target.closest('#next-day-btn');

                if (deleteBtn) {
                    const taskId = deleteBtn.dataset.taskId;
                    const taskText = state.tasks.find(t => t.id === taskId)?.text || '';
                    if (confirm(`'${taskText}' görevini silmek istediğinizden emin misiniz?`)) {
                       deleteTask(taskId);
                    }
                }
                if (prevDayBtn) changeDate(-1);
                if (nextDayBtn) changeDate(1);
            });

            appContainer.addEventListener('submit', (e) => {
                if (e.target.id === 'add-task-form') {
                    e.preventDefault();
                    const textInput = document.getElementById('new-task-text');
                    const pointsInput = document.getElementById('new-task-points');
                    if (textInput.value.trim()) {
                        addTask(textInput.value.trim(), pointsInput.value);
                    }
                }
            });
        }

        // --- UYGULAMAYI BAŞLATMA ---
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            renderApp();
            attachEventListeners();
        });
    </script>
</body>
</html>
